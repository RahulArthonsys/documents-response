{% extends "administrator/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
<style>
  .main-footer { display: none !important; }
  body, html { overflow: hidden !important; }
  .nova-chat-page {
    position: fixed;
    top: calc(3.5rem + 1px);
    bottom: 0; right: 0;
    left: 250px;
    overflow: hidden;
    display: flex;
    background: var(--nova-50, #f8fafc);
    z-index: 10;
    transition: left 0.3s ease-in-out;
  }
  body.sidebar-mini.sidebar-collapse .nova-chat-page { left: 4.6rem; }
</style>
{% endblock %}

{% block body %}
<!-- Inject Django data for React -->
<script>
window.__CLAIRE__ = {
  conversationId: {{ conversation.pk }},
  currentConvId: {{ current_conv_id|default:"0" }},
  conversationTitle: "{{ conversation.title|default:'New Conversation'|escapejs }}",
  csrfToken: "{{ csrf_token }}",
  urls: {
    ask: "{% url 'claire-ask' %}",
    upload: "{% url 'claire-session-upload' %}",
    assistant: "{% url 'claire-assistant' %}",
    history: "{% url 'claire-history' %}",
    deleteConv: "{% url 'claire-delete-conversation' %}",
    clearHistory: "{% url 'claire-clear-history' %}",
    dashboard: "{% url 'admin-dashboard' %}"
  },
  groupedConversations: [
    {% for date_key, convs in grouped_conversations.items %}
    {
      label: "{% if date_key == today %}Today{% elif date_key == yesterday %}Yesterday{% else %}{{ date_key|date:'M d, Y' }}{% endif %}",
      conversations: [
        {% for conv in convs %}
        {
          id: {{ conv.pk }},
          title: "{{ conv.title|default:'New Chat'|truncatechars:28|escapejs }}",
          messageCount: {{ conv.message_count }},
          isActive: {% if conv.pk == current_conv_id %}true{% else %}false{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  initialMessages: [
    {% for msg in chat_messages %}
    {
      role: "{{ msg.role }}",
      content: "{{ msg.content|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
};
</script>

<div id="nova-claire-root"></div>

<!-- Markdown libs -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/json.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/sql.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<!-- React Claire App -->
<script type="text/babel">
{% verbatim %}
const { useState, useEffect, useRef, useCallback, useMemo } = React;
const C = window.__CLAIRE__;

/* â”€â”€ Markdown helpers â”€â”€ */
function initMarked() {
  if (typeof marked !== 'undefined') {
    marked.setOptions({ breaks: true, gfm: true,
      highlight: (code, lang) => {
        if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
          try { return hljs.highlight(code, { language: lang }).value; } catch(e) {}
        }
        return code;
      }
    });
  }
}
initMarked();

function renderMarkdown(text) {
  if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
    try { return DOMPurify.sanitize(marked.parse(text)); } catch(e) {}
  }
  const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
}

/* â”€â”€ Conversation Sidebar â”€â”€ */
function ChatSidebar({ groups, onDelete, onNewChat, onClearHistory, countdown }) {
  const [search, setSearch] = useState('');

  const filtered = useMemo(() => {
    if (!search.trim()) return groups;
    const q = search.toLowerCase();
    return groups.map(g => ({
      ...g,
      conversations: g.conversations.filter(c => c.title.toLowerCase().includes(q))
    })).filter(g => g.conversations.length > 0);
  }, [groups, search]);

  return (
    <div className="nova-chat-sidebar">
      <div className="nova-chat-sidebar-header">
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', width: '100%' }}>
          <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
            <i className="fas fa-comments" style={{ color: 'var(--nova-primary)', fontSize: '1rem' }}></i>
            <span>Chats</span>
          </h3>
          <div style={{ display: 'flex', gap: '8px' }}>
            <button onClick={onNewChat} title="New Chat"
              style={{
                width: '32px', height: '32px', borderRadius: '12px', border: 'none', cursor: 'pointer',
                background: 'linear-gradient(135deg, #4f8ef7, #6366f1)', color: '#fff',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '0.75rem', boxShadow: '0 2px 8px rgba(79,142,247,0.3)',
                transition: 'all 0.2s ease'
              }}>
              <i className="fas fa-plus"></i>
            </button>
            <button onClick={onClearHistory} title="Clear All"
              style={{
                width: '32px', height: '32px', borderRadius: '12px', border: 'none', cursor: 'pointer',
                background: 'rgba(239,68,68,0.1)', color: '#ef4444',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '0.72rem', transition: 'all 0.2s ease'
              }}>
              <i className="fas fa-trash-alt"></i>
            </button>
          </div>
        </div>
      </div>
      <div className="nova-chat-sidebar-search">
        <i className="fas fa-search" style={{ position: 'absolute', left: '28px', top: '50%', transform: 'translateY(-50%)', color: '#94a3b8', fontSize: '0.75rem', pointerEvents: 'none' }}></i>
        <input type="text" placeholder="Search chats..." value={search}
          onChange={e => setSearch(e.target.value)} />
      </div>
      <div className="nova-chat-list">
        {filtered.length === 0 ? (
          <div style={{ textAlign: 'center', padding: '32px 16px', color: '#94a3b8' }}>
            <i className="fas fa-inbox" style={{ fontSize: '1.6rem', marginBottom: '10px', display: 'block' }}></i>
            <span style={{ fontSize: '0.82rem' }}>No conversations yet.</span>
          </div>
        ) : filtered.map((group, gi) => (
          <div key={gi}>
            <div style={{
              fontSize: '0.68rem', fontWeight: 700, color: '#94a3b8',
              textTransform: 'uppercase', letterSpacing: '0.5px',
              padding: '12px 16px 4px', userSelect: 'none'
            }}>{group.label}</div>
            {group.conversations.map(conv => (
              <div key={conv.id}
                className={`nova-chat-item ${conv.isActive ? 'active' : ''}`}
                onClick={() => window.location.href = `${C.urls.assistant}?conv_id=${conv.id}`}>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ fontWeight: 600, fontSize: '0.85rem', whiteSpace: 'nowrap',
                    overflow: 'hidden', textOverflow: 'ellipsis' }}>{conv.title}</div>
                  <div style={{ fontSize: '0.72rem', opacity: 0.6, marginTop: '2px' }}>
                    {conv.messageCount} messages
                  </div>
                </div>
                <button className="btn btn-xs" title="Delete"
                  onClick={e => { e.stopPropagation(); onDelete(conv.id); }}
                  style={{
                    background: 'transparent', border: 'none',
                    color: conv.isActive ? 'rgba(255,255,255,0.6)' : '#ef4444',
                    padding: '4px 6px', borderRadius: '6px', flexShrink: 0
                  }}>
                  <i className="fas fa-times" style={{ fontSize: '0.7rem' }}></i>
                </button>
              </div>
            ))}
          </div>
        ))}
      </div>
      {countdown && (
        <div style={{
          padding: '8px 16px', textAlign: 'center', borderTop: '1px solid var(--nova-200, #e2e8f0)',
          fontSize: '0.75rem', color: 'var(--nova-primary)'
        }}>
          <i className="fas fa-sync-alt" style={{ marginRight: '4px' }}></i>{countdown}
        </div>
      )}
    </div>
  );
}

/* â”€â”€ Chat Bubble â”€â”€ */
function ChatBubble({ role, content }) {
  const ref = useRef(null);
  useEffect(() => {
    if (ref.current && (role === 'assistant' || role === 'system')) {
      ref.current.innerHTML = renderMarkdown(content);
    }
  }, [content, role]);

  if (role === 'system') {
    return (
      <div className="nova-bubble-wrap system">
        <div className="nova-bubble system"><div ref={ref}></div></div>
      </div>
    );
  }

  return (
    <div className={`nova-bubble-wrap ${role}`}>
      <div className="nova-bubble-avatar">
        <i className={`fas fa-${role === 'user' ? 'user' : 'robot'}`}></i>
      </div>
      <div className={`nova-bubble ${role}`}>
        {role === 'assistant' ? <div ref={ref}></div> : content}
      </div>
    </div>
  );
}

/* â”€â”€ Typing Indicator â”€â”€ */
function TypingIndicator() {
  return (
    <div className="nova-bubble-wrap assistant">
      <div className="nova-bubble-avatar"><i className="fas fa-robot"></i></div>
      <div className="nova-bubble assistant">
        <div className="nova-typing"><span></span><span></span><span></span></div>
      </div>
    </div>
  );
}

/* â”€â”€ Empty State â€” Premium Hero â”€â”€ */
function EmptyState() {
  const suggestions = [
    { icon: 'fas fa-search', text: 'Search my knowledge base', color: '#4f8ef7', bg: 'rgba(79,142,247,0.08)' },
    { icon: 'fas fa-file-alt', text: 'Summarize a document', color: '#8b5cf6', bg: 'rgba(139,92,246,0.08)' },
    { icon: 'fas fa-chart-line', text: 'Analyze uploaded data', color: '#0ea5e9', bg: 'rgba(14,165,233,0.08)' },
    { icon: 'fas fa-lightbulb', text: 'Help me brainstorm', color: '#f59e0b', bg: 'rgba(245,158,11,0.08)' },
  ];

  return (
    <div className="nova-chat-empty">
      {/* Animated gradient orb */}
      <div className="nova-hero-orb">
        <div className="nova-hero-orb-inner">
          <i className="fas fa-robot" style={{ fontSize: '2.2rem' }}></i>
        </div>
        <div className="nova-hero-orb-ring"></div>
        <div className="nova-hero-orb-ring" style={{ animationDelay: '0.5s', width: '130px', height: '130px' }}></div>
      </div>

      <h2 style={{ fontWeight: 800, fontSize: '1.8rem', margin: '28px 0 6px', letterSpacing: '-0.5px' }}
        className="nova-empty-title">Hello, I'm Claire</h2>
      <p style={{ maxWidth: '440px', lineHeight: 1.7, margin: '0 0 32px' }}
        className="nova-empty-subtitle">
        Your intelligent AI assistant. I can search your knowledge base,
        analyze documents, and help you find answers instantly.
      </p>

      {/* Suggestion cards grid */}
      <div style={{
        display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px',
        maxWidth: '480px', width: '100%'
      }}>
        {suggestions.map((s, i) => (
          <div key={i} className="nova-suggestion-card" style={{
            display: 'flex', alignItems: 'center', gap: '12px',
            padding: '14px 16px', borderRadius: '18px',
            background: s.bg, cursor: 'pointer',
            transition: 'all 0.2s ease', border: '1px solid transparent',
            animationDelay: `${0.1 + i * 0.08}s`
          }}
          onMouseEnter={e => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.borderColor = s.color + '33'; e.currentTarget.style.boxShadow = `0 4px 16px ${s.color}20`; }}
          onMouseLeave={e => { e.currentTarget.style.transform = ''; e.currentTarget.style.borderColor = 'transparent'; e.currentTarget.style.boxShadow = 'none'; }}
          >
            <div style={{
              width: '36px', height: '36px', borderRadius: '12px',
              background: s.color + '18', color: s.color,
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              fontSize: '0.85rem', flexShrink: 0
            }}>
              <i className={s.icon}></i>
            </div>
            <span style={{ fontSize: '0.82rem', fontWeight: 600, color: s.color }}>{s.text}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Main Claire App
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ClaireApp() {
  const [messages, setMessages] = useState(() =>
    C.initialMessages.map((m, i) => ({ id: i, ...m }))
  );
  const [isTyping, setIsTyping] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [inputVal, setInputVal] = useState('');
  const [pendingFile, setPendingFile] = useState(null);
  const [uploadProgress, setUploadProgress] = useState(null); // null | { name, pct }
  const [countdown, setCountdown] = useState(null);
  const [groups, setGroups] = useState(C.groupedConversations);
  const convIdRef = useRef(C.conversationId);
  const messagesEndRef = useRef(null);
  const chatAreaRef = useRef(null);
  const inputRef = useRef(null);
  const fileInputRef = useRef(null);
  const streamContentRef = useRef('');
  const nextIdRef = useRef(C.initialMessages.length);

  function scrollToBottom() {
    if (chatAreaRef.current) {
      chatAreaRef.current.scrollTop = chatAreaRef.current.scrollHeight;
    }
  }

  useEffect(() => { scrollToBottom(); }, [messages, isTyping]);
  useEffect(() => { if (inputRef.current) inputRef.current.focus(); }, []);

  // Auto-resize textarea
  useEffect(() => {
    if (inputRef.current) {
      const ta = inputRef.current;
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 168) + 'px';
    }
  }, [inputVal]);

  /* â”€â”€ Midnight countdown â”€â”€ */
  useEffect(() => {
    function getMsUntilMidnight() {
      const now = new Date();
      const midnight = new Date(now);
      midnight.setHours(24, 0, 0, 0);
      return midnight.getTime() - now.getTime();
    }
    function formatTime(ms) {
      const s = Math.floor(ms / 1000);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (h > 0) return `${h}h ${m}m ${sec}s`;
      if (m > 0) return `${m}m ${sec}s`;
      return `${sec}s`;
    }
    function check() {
      const ms = getMsUntilMidnight();
      if (ms <= 300000) setCountdown(`Fresh chat in ${formatTime(ms)}`);
      if (ms <= 1000) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({ title: 'New Day, Fresh Chat!',
            text: "It's midnight â€” starting a fresh conversation.",
            icon: 'info', timer: 3000, showConfirmButton: false
          }).then(() => { window.location.href = C.urls.assistant; });
        } else { window.location.href = C.urls.assistant; }
        return;
      }
      setTimeout(check, ms <= 60000 ? 1000 : 60000);
    }
    check();
  }, []);

  /* â”€â”€ Helpers â”€â”€ */
  function addMessage(role, content) {
    const id = nextIdRef.current++;
    setMessages(prev => [...prev, { id, role, content }]);
    return id;
  }

  function updateMessage(id, content) {
    setMessages(prev => prev.map(m => m.id === id ? { ...m, content } : m));
  }

  /* â”€â”€ File Upload â”€â”€ */
  function handleFileSelect(e) {
    if (e.target.files.length > 0) {
      setPendingFile(e.target.files[0]);
    }
  }

  function removePendingFile() {
    setPendingFile(null);
    if (fileInputRef.current) fileInputRef.current.value = '';
  }

  function uploadFile(file) {
    return new Promise((resolve, reject) => {
      setUploadProgress({ name: file.name, pct: 0 });
      const formData = new FormData();
      formData.append('file', file);
      formData.append('conversation_id', convIdRef.current);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', C.urls.upload);
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          setUploadProgress({ name: file.name, pct: Math.round((e.loaded / e.total) * 100) });
        }
      };
      xhr.onload = () => {
        setUploadProgress(null);
        setPendingFile(null);
        if (fileInputRef.current) fileInputRef.current.value = '';
        if (xhr.status === 200) {
          const data = JSON.parse(xhr.responseText);
          addMessage('system', `ðŸ“Ž File uploaded: **${data.filename}** (${data.chunks} chunks indexed)`);
          resolve(data);
        } else {
          let err = 'Upload failed';
          try { err = JSON.parse(xhr.responseText).error || err; } catch(e) {}
          addMessage('system', `âš ï¸ ${err}`);
          reject(err);
        }
      };
      xhr.onerror = () => { setUploadProgress(null); reject('Network error'); };
      xhr.send(formData);
    });
  }

  /* â”€â”€ SSE Send Message â”€â”€ */
  function doSendText(msg) {
    addMessage('user', msg);
    setIsTyping(true);
    streamContentRef.current = '';
    let streamMsgId = null;

    fetch(C.urls.ask, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': C.csrfToken },
      body: JSON.stringify({ message: msg, conversation_id: convIdRef.current, stream: true })
    }).then(response => {
      setIsTyping(false);
      if (!response.ok) {
        return response.json().then(d => {
          addMessage('assistant', 'Error: ' + (d.error || 'Unknown error'));
          setIsSending(false);
          if (inputRef.current) inputRef.current.focus();
        });
      }

      // Create the stream bubble
      streamMsgId = nextIdRef.current++;
      setMessages(prev => [...prev, { id: streamMsgId, role: 'assistant', content: '' }]);

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      function processStream() {
        return reader.read().then(result => {
          if (result.done) {
            if (streamContentRef.current) {
              updateMessage(streamMsgId, streamContentRef.current);
            }
            setIsSending(false);
            if (inputRef.current) inputRef.current.focus();
            return;
          }

          buffer += decoder.decode(result.value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed.startsWith('data: ')) continue;
            try {
              const data = JSON.parse(trimmed.substring(6));
              if (data.type === 'token') {
                streamContentRef.current += data.content;
                updateMessage(streamMsgId, streamContentRef.current);
              } else if (data.type === 'done') {
                convIdRef.current = data.conversation_id || convIdRef.current;
                updateMessage(streamMsgId, streamContentRef.current);
                setIsSending(false);
                if (inputRef.current) inputRef.current.focus();
                return;
              }
            } catch(e) { /* skip */ }
          }
          return processStream();
        });
      }
      return processStream();
    }).catch(() => {
      setIsTyping(false);
      addMessage('assistant', 'Network error. Please try again.');
      setIsSending(false);
      if (inputRef.current) inputRef.current.focus();
    });
  }

  function handleSend() {
    const msg = inputVal.trim();
    if (!msg && !pendingFile) return;
    setInputVal('');
    setIsSending(true);

    if (pendingFile) {
      const file = pendingFile;
      uploadFile(file).then(() => {
        if (msg) doSendText(msg);
        else { setIsSending(false); if (inputRef.current) inputRef.current.focus(); }
      }).catch(() => {
        if (msg) doSendText(msg);
        else { setIsSending(false); if (inputRef.current) inputRef.current.focus(); }
      });
      return;
    }
    doSendText(msg);
  }

  function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
  }

  /* â”€â”€ CRUD â”€â”€ */
  function handleDeleteConv(convId) {
    const doDelete = () => {
      if (typeof Swal !== 'undefined') {
        return Swal.fire({ title: 'Delete Conversation?',
          text: 'This will permanently delete this conversation.',
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Delete!'
        });
      }
      return Promise.resolve({ value: confirm('Delete this conversation?') });
    };
    doDelete().then(result => {
      if (!result.value) return;
      const fd = new FormData(); fd.append('conv_id', convId);
      fetch(C.urls.deleteConv, { method: 'POST', headers: { 'X-CSRFToken': C.csrfToken }, body: fd })
        .then(r => r.json())
        .then(data => {
          if (data.status === 'ok') {
            setGroups(prev => prev.map(g => ({
              ...g, conversations: g.conversations.filter(c => c.id !== convId)
            })).filter(g => g.conversations.length > 0));
            if (convId == C.currentConvId) window.location.href = C.urls.assistant;
          } else { alert(data.message || 'Failed to delete.'); }
        }).catch(() => alert('Network error.'));
    });
  }

  function handleClearHistory() {
    const doClear = () => {
      if (typeof Swal !== 'undefined') {
        return Swal.fire({ title: 'Clear All Chat History?',
          text: 'This will permanently delete ALL conversations.',
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Clear All!'
        });
      }
      return Promise.resolve({ value: confirm('Clear all history?') });
    };
    doClear().then(result => {
      if (!result.value) return;
      fetch(C.urls.clearHistory, {
        method: 'POST',
        headers: { 'X-CSRFToken': C.csrfToken, 'Content-Type': 'application/json' }
      }).then(r => r.json())
        .then(data => {
          if (data.status === 'ok') window.location.href = data.redirect_url || C.urls.assistant;
          else alert(data.message || 'Failed to clear history.');
        }).catch(() => alert('Network error.'));
    });
  }

  function handleNewChat() {
    window.location.href = `${C.urls.assistant}?new=1`;
  }

  /* â”€â”€ Render â”€â”€ */
  return (
    <div className="nova-chat-page">
      {/* Sidebar */}
      <ChatSidebar groups={groups} onDelete={handleDeleteConv}
        onNewChat={handleNewChat} onClearHistory={handleClearHistory} countdown={countdown} />

      {/* Main Chat Area */}
      <div className="nova-chat-main">
        {/* Top Bar â€” Glassmorphism */}
        <div className="nova-chat-topbar">
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
            <div className="nova-topbar-avatar">
              <i className="fas fa-robot" style={{ color: '#fff', fontSize: '0.95rem' }}></i>
              <span className="nova-topbar-status-dot"></span>
            </div>
            <div>
              <div className="nova-topbar-title">{C.conversationTitle}</div>
              <div className="nova-topbar-status">
                <span className="nova-status-pulse"></span>
                Online &mdash; Ready to assist
              </div>
            </div>
          </div>
          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
            <a href={`${C.urls.assistant}?new=1`} className="nova-topbar-btn nova-topbar-btn-primary">
              <i className="fas fa-plus"></i> New Chat
            </a>
            <a href={C.urls.history} className="nova-topbar-btn nova-topbar-btn-ghost">
              <i className="fas fa-history"></i> History
            </a>
          </div>
        </div>

        {/* Messages Area */}
        <div className="nova-chat-messages" ref={chatAreaRef}>
          {messages.length === 0 ? <EmptyState /> : (
            messages.map(msg => <ChatBubble key={msg.id} role={msg.role} content={msg.content} />)
          )}
          {isTyping && <TypingIndicator />}
          <div ref={messagesEndRef} />
        </div>

        {/* Upload Progress */}
        {uploadProgress && (
          <div className="nova-upload-bar">
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '4px' }}>
              <span style={{ fontSize: '0.78rem', color: '#64748b' }}>
                <i className="fas fa-paperclip" style={{ marginRight: '4px' }}></i>
                Uploading {uploadProgress.name}...
              </span>
              <span style={{ fontSize: '0.78rem', fontWeight: 600, color: '#4f8ef7' }}>{uploadProgress.pct}%</span>
            </div>
            <div className="nova-upload-progress">
              <div style={{ width: `${uploadProgress.pct}%` }}></div>
            </div>
          </div>
        )}

        {/* Pending File Badge */}
        {pendingFile && !uploadProgress && (
          <div style={{ padding: '0 20px', paddingBottom: '4px' }}>
            <div style={{
              display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '6px 12px',
              background: 'rgba(79,142,247,0.08)', borderRadius: '20px', fontSize: '0.8rem', color: '#4f8ef7'
            }}>
              <i className="fas fa-paperclip"></i>
              <span>{pendingFile.name}</span>
              <span style={{ cursor: 'pointer', color: '#ef4444', fontWeight: 700, marginLeft: '4px' }}
                onClick={removePendingFile}>&times;</span>
            </div>
          </div>
        )}

        {/* Input Area â€” Refined */}
        <div className="nova-chat-input-area">
          <div className="nova-chat-input-wrapper">
            <button className="nova-chat-attach-btn" onClick={() => fileInputRef.current && fileInputRef.current.click()}
              title="Upload file">
              <i className="fas fa-paperclip"></i>
            </button>
            <textarea className="nova-chat-textarea" rows="1" ref={inputRef}
              placeholder="Message Claire..." value={inputVal}
              onChange={e => setInputVal(e.target.value)}
              onKeyDown={handleKeyDown}
              style={{ resize: 'none', overflow: 'hidden' }}
            />
            <button className={`nova-chat-send-btn ${(inputVal.trim() || pendingFile) && !isSending ? 'active' : ''}`}
              onClick={handleSend} disabled={isSending}>
              <i className="fas fa-arrow-up"></i>
            </button>
          </div>
          <input type="file" ref={fileInputRef} style={{ display: 'none' }}
            accept=".pdf,.txt,.doc,.docx,.pptx,.xlsx,.csv,.json,.xml"
            onChange={handleFileSelect} />
          <div className="nova-input-disclaimer">
            <i className="fas fa-shield-alt" style={{ marginRight: '4px', fontSize: '0.6rem' }}></i>
            Claire can make mistakes. Please verify important information.
          </div>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€ Mount â”€â”€ */
const root = ReactDOM.createRoot(document.getElementById('nova-claire-root'));
root.render(<ClaireApp />);
{% endverbatim %}
</script>
{% endblock %}
