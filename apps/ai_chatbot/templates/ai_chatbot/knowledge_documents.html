{% extends "administrator/base.html" %}
{% load static %}

{% block body %}
<!-- Content Header -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0 text-dark">AI Knowledge Documents</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'admin-dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item active">Knowledge Documents</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">

    <!-- Stat Boxes -->
    <div class="row">
      <div class="col-lg-4 col-6">
        <div class="small-box bg-info">
          <div class="inner">
            <h3>{{ total_count }}</h3>
            <p>Total Documents</p>
          </div>
          <div class="icon"><i class="fas fa-file-alt"></i></div>
        </div>
      </div>
      <div class="col-lg-4 col-6">
        <div class="small-box bg-success">
          <div class="inner">
            <h3>{{ processed_count }}</h3>
            <p>Processed</p>
          </div>
          <div class="icon"><i class="fas fa-check-circle"></i></div>
        </div>
      </div>
      <div class="col-lg-4 col-6">
        <div class="small-box bg-warning">
          <div class="inner">
            <h3>{{ total_count|add:"-"|add:processed_count }}</h3>
            <p>Pending Processing</p>
          </div>
          <div class="icon"><i class="fas fa-clock"></i></div>
        </div>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible">
      <button type="button" class="close" data-dismiss="alert">&times;</button>
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <!-- Documents Table Card -->
    <div class="card card-primary card-outline">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-database mr-2"></i>Knowledge Base Documents</h3>
        <div class="card-tools">
          <a href="{% url 'admin-knowledge-upload' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-upload mr-1"></i> Upload Document
          </a>
        </div>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped table-hover">
          <thead class="thead-light">
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>File Name</th>
              <th>Embedding Metadata</th>
              <th>Upload Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in documents %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td><strong>{{ doc.title }}</strong></td>
              <td>
                {% if doc.file %}
                <a href="{{ doc.file.url }}" target="_blank" class="text-primary">
                  <i class="fas fa-file-download mr-1"></i>{{ doc.filename }}
                </a>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if doc.embedding_metadata %}
                  {% with meta=doc.embedding_metadata %}
                  <small class="text-muted">{{ meta|truncatechars:80 }}</small>
                  {% endwith %}
                {% elif doc.is_processed %}
                  <span class="badge badge-success"><i class="fas fa-check mr-1"></i>Indexed</span>
                {% else %}
                  <span class="badge badge-warning"><i class="fas fa-clock mr-1"></i>Pending</span>
                {% endif %}
              </td>
              <td>{{ doc.uploaded_at|date:"M d, Y H:i" }}</td>
              <td>
                <button class="btn btn-danger btn-xs btn-delete-doc"
                        data-url="{% url 'admin-knowledge-delete' doc.pk %}"
                        data-token="{{ csrf_token }}">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                No documents uploaded yet.
                <a href="{% url 'admin-knowledge-upload' %}">Upload your first document</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if documents.has_other_pages %}
      <div class="card-footer clearfix">
        <ul class="pagination pagination-sm m-0 float-right">
          {% if documents.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ documents.previous_page_number }}">«</a>
          </li>
          {% endif %}
          <li class="page-item active">
            <span class="page-link">{{ documents.number }} / {{ documents.paginator.num_pages }}</span>
          </li>
          {% if documents.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ documents.next_page_number }}">»</a>
          </li>
          {% endif %}
        </ul>
      </div>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}

{% block script %}
$(document).on('click', '.btn-delete-doc', function () {
  var btn = $(this);
  var url = btn.data('url');
  var token = btn.data('token');
  var row = btn.closest('tr');
  Swal.fire({
    title: 'Do you really want to delete this record',
    text: 'This process cannot be undone.',
    type: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#999999',
    confirmButtonText: 'Delete!',
    cancelButtonText: 'Cancel'
  }).then(function (result) {
    if (result.value) {
      $.ajax({
        url: url,
        method: 'POST',
        data: { csrfmiddlewaretoken: token },
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function () {
          row.fadeOut(300, function () { $(this).remove(); });
          Swal.fire('Deleted', '', 'success');
        },
        error: function () {
          Swal.fire('Error', 'Could not delete. Please try again.', 'error');
        }
      });
    } else if (result.dismiss === Swal.DismissReason.cancel) {
      Swal.fire('Cancelled', '', 'error');
    }
  });
});
{% endblock %}
