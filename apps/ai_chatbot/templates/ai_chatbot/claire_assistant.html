{% extends "administrator/base.html" %}
{% load static %}

{% block extra_css %}
<!-- Markdown rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
<style>
  /* ‚îÄ‚îÄ Hide footer, prevent page scroll ‚îÄ‚îÄ */
  .main-footer { display: none !important; }
  body, html { overflow: hidden !important; }

  /* ‚îÄ‚îÄ claire-page: fixed overlay covering content area ‚îÄ‚îÄ
     AdminLTE navbar  = 3.5rem + 1px ‚âà 57px (top offset)
     AdminLTE sidebar  = 250px wide (left offset), collapses to 4.6rem
  */
  .claire-page {
    position: fixed;
    top: calc(3.5rem + 1px); /* below top navbar */
    bottom: 0;
    right: 0;
    left: 250px;             /* default sidebar width */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #ecf0f4;
    z-index: 10;
    transition: left 0.3s ease-in-out; /* match sidebar animation */
  }
  /* sidebar collapsed state */
  body.sidebar-mini.sidebar-collapse .claire-page { left: 4.6rem; }

  /* ‚îÄ‚îÄ Content header ‚Äî compact breadcrumb bar ‚îÄ‚îÄ */
  .claire-page .content-header {
    flex-shrink: 0;
    padding: 6px 15px;
    margin-bottom: 0;
    background: #ecf0f4;
  }
  .claire-page .content-header h1 { font-size: 1.25rem; margin: 0; }
  .claire-page .content-header .breadcrumb { margin-bottom: 0; }

  /* ‚îÄ‚îÄ Section.content ‚Äî fills rest of the space ‚îÄ‚îÄ */
  .claire-page section.content {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 0 12px 8px;
  }
  .claire-page section.content > .container-fluid {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 0;
    margin: 0;
    max-width: 100%;
  }
  .claire-page section.content > .container-fluid > .row {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    flex-wrap: nowrap;
    margin: 0 -6px;
  }
  .claire-page section.content > .container-fluid > .row > [class*="col-"] {
    padding: 0 6px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Sidebar column ‚îÄ‚îÄ */
  .sidebar-col {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .sidebar-col > .card {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    margin-bottom: 0;
    border-radius: 8px;
    overflow: hidden;
  }
  .sidebar-col > .card > .card-header { flex-shrink: 0; }
  .sidebar-col > .card > .card-body {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    padding: 8px;
  }
  .sidebar-col > .card > .card-footer { flex-shrink: 0; }

  /* Conversation items */
  .conversation-item { transition: background 0.15s; border-radius: 6px; }
  .conversation-item:hover { background: #e9ecef; }
  .conversation-item.active-conv { background: #007bff !important; color: #fff !important; }
  .conversation-item.active-conv .text-muted,
  .conversation-item.active-conv .font-weight-medium { color: #fff !important; }
  .conversation-item.active-conv .btn-outline-danger {
    color: #fff !important; border-color: rgba(255,255,255,0.5) !important;
  }

  /* ‚îÄ‚îÄ Chat column ‚îÄ‚îÄ */
  .chat-col {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .chat-col > .card {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    margin-bottom: 0;
    border-radius: 8px;
    overflow: hidden;
  }
  .chat-col > .card > .card-header { flex-shrink: 0; }
  .chat-col > .card > .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding: 0;
  }

  /* ‚îÄ‚îÄ Chat wrapper ‚îÄ‚îÄ */
  .chat-wrapper {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    padding: 0 12px 8px;
  }
  .chat-messages {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 6px;
  }
  .chat-input-bar { flex-shrink: 0; padding: 10px 0 4px; }
  .file-upload-area { flex-shrink: 0; }
  .file-progress { flex-shrink: 0; display: none; margin-top: 4px; }

  /* ‚îÄ‚îÄ Bubbles: user RIGHT, assistant LEFT ‚îÄ‚îÄ */
  .chat-bubble {
    max-width: 75%;
    margin-bottom: 14px;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }
  .chat-bubble.user   { flex-direction: row-reverse; margin-left: auto; margin-right: 0; }
  .chat-bubble.assistant { flex-direction: row; margin-right: auto; margin-left: 0; }
  .chat-bubble.system { max-width: 100%; justify-content: center; }

  .chat-bubble .bubble-content {
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 0.92rem;
    line-height: 1.6;
    word-break: break-word;
  }
  .chat-bubble .bubble-content p { margin-bottom: 0.4rem; }
  .chat-bubble .bubble-content p:last-child { margin-bottom: 0; }
  .chat-bubble .bubble-content pre {
    background: #1e1e1e; color: #d4d4d4;
    padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 0.85rem;
  }
  .chat-bubble .bubble-content code {
    background: #e9ecef; padding: 1px 4px; border-radius: 3px; font-size: 0.88em;
  }
  .chat-bubble .bubble-content pre code { background: none; padding: 0; }
  .chat-bubble .bubble-content table {
    width: 100%; border-collapse: collapse; margin: 8px 0;
  }
  .chat-bubble .bubble-content table th,
  .chat-bubble .bubble-content table td {
    border: 1px solid #dee2e6; padding: 6px 8px; font-size: 0.85rem;
  }
  .chat-bubble .bubble-content table th { background: #f0f0f0; }

  .chat-bubble.user .bubble-content {
    background: #007bff; color: #fff; border-bottom-right-radius: 4px;
  }
  .chat-bubble.user .bubble-content code { background: rgba(255,255,255,0.2); color: #fff; }
  .chat-bubble.assistant .bubble-content {
    background: #fff; color: #333; border: 1px solid #dee2e6; border-bottom-left-radius: 4px;
  }
  .chat-bubble.system .bubble-content {
    background: #e8f5e9; color: #2e7d32; font-size: 0.82rem; border-radius: 8px;
  }

  .chat-bubble .avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; flex-shrink: 0;
  }
  .chat-bubble.user .avatar { background: #007bff; color: #fff; }
  .chat-bubble.assistant .avatar { background: #17a2b8; color: #fff; }

  .file-upload-area {
    display: flex; align-items: center; gap: 6px; padding: 4px 0;
  }
  .file-upload-area .file-info {
    font-size: 0.82rem; color: #666; display: flex; align-items: center; gap: 4px;
  }
  .file-upload-area .file-info .remove-file { color: #dc3545; cursor: pointer; }
  .typing-indicator span {
    display: inline-block; width: 7px; height: 7px; border-radius: 50%;
    background: #aaa; margin: 0 2px; animation: bounce 1.2s infinite;
  }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-6px)} }
</style>
{% endblock %}

{% block body %}
<div class="claire-page">
<!-- Content Header -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0 text-dark">
          <i class="fas fa-robot text-info mr-2"></i>ArthaCore AI
        </h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'admin-dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item active">ArthaCore AI</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">
    <div class="row">

      <!-- Conversation Sidebar -->
      <div class="col-md-3 sidebar-col">
        <div class="card card-outline card-info">
          <div class="card-header d-flex align-items-center justify-content-between py-2">
            <h3 class="card-title mb-0"><i class="fas fa-comments mr-1"></i> Chats</h3>
            <div>
              <button class="btn btn-sm btn-primary" id="newChatBtn" title="Start New Chat">
                <i class="fas fa-plus"></i>
              </button>
              <button class="btn btn-sm btn-danger ml-1" id="clearHistoryBtn" title="Clear All History">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="card-body p-2">
            {% for date_key, convs in grouped_conversations.items %}
            <div class="mb-3">
              <small class="text-muted font-weight-bold text-uppercase px-1">
                {% if date_key == today %}Today
                {% elif date_key == yesterday %}Yesterday
                {% else %}{{ date_key|date:"M d, Y" }}
                {% endif %}
              </small>
              {% for conv in convs %}
              <div class="conversation-item d-flex align-items-center justify-content-between px-2 py-1 rounded mb-1 {% if conv.pk == current_conv_id %}active-conv{% endif %}"
                   data-conv-id="{{ conv.pk }}" style="cursor:pointer;">
                <div class="flex-grow-1 text-truncate" style="min-width:0;"
                     onclick="window.location.href='{% url 'claire-assistant' %}?conv_id={{ conv.pk }}'">
                  <span class="font-weight-medium text-sm">{{ conv.title|default:"New Chat"|truncatechars:28 }}</span>
                  <br>
                  <small class="text-muted">
                    <span class="message-count-display">{{ conv.message_count }}</span> msgs
                  </small>
                </div>
                <button class="btn btn-xs btn-outline-danger ml-1 delete-conv-btn"
                        data-conv-id="{{ conv.pk }}" title="Delete"
                        onclick="event.stopPropagation(); deleteConversation({{ conv.pk }});">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              {% endfor %}
            </div>
            {% empty %}
            <p class="text-muted text-sm text-center mt-3">No conversations yet.</p>
            {% endfor %}
          </div>
          <!-- Midnight countdown (hidden by default) -->
          <div class="card-footer py-1 text-center" id="midnightCountdown" style="display:none;">
            <small class="text-info">
              <i class="fas fa-sync-alt"></i> <span id="countdownText">Calculating...</span>
            </small>
          </div>
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="col-md-9 chat-col">
        <div class="card card-primary card-outline direct-chat direct-chat-primary">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h3 class="card-title mb-0">
              <i class="fas fa-comment-dots mr-2"></i>
              {{ conversation.title|default:"New Conversation" }}
            </h3>
            <div class="ml-auto">
              <a href="{% url 'claire-history' %}" class="btn btn-warning btn-sm font-weight-bold shadow-sm">
                <i class="fas fa-history mr-1"></i> History
              </a>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="chat-wrapper px-3 py-2">
              <!-- Messages -->
              <div class="chat-messages" id="chatMessages">
                {% if not chat_messages %}
                <div class="text-center text-muted mt-4" id="emptyState">
                  <i class="fas fa-robot fa-3x mb-3 text-info"></i>
                  <p class="font-weight-bold">Hello! I'm ArthaCore AI, your AI assistant.</p>
                  <p>Ask me anything about your knowledge base documents, or upload a file to analyze.</p>
                </div>
                {% endif %}
                {% for msg in chat_messages %}
                <div class="chat-bubble {{ msg.role }}">
                  {% if msg.role != 'system' %}
                  <div class="avatar">
                    {% if msg.role == 'user' %}
                      <i class="fas fa-user"></i>
                    {% else %}
                      <i class="fas fa-robot"></i>
                    {% endif %}
                  </div>
                  {% endif %}
                  <div class="bubble-content">{% if msg.role == 'assistant' %}{{ msg.content }}{% else %}{{ msg.content }}{% endif %}</div>
                </div>
                {% endfor %}
                <!-- Typing indicator (hidden by default) -->
                <div class="chat-bubble assistant" id="typingIndicator" style="display:none;">
                  <div class="avatar"><i class="fas fa-robot"></i></div>
                  <div class="bubble-content">
                    <div class="typing-indicator">
                      <span></span><span></span><span></span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- File upload status -->
              <div class="file-upload-area" id="fileUploadArea" style="display:none;">
                <div class="file-info" id="fileInfo">
                  <i class="fas fa-paperclip"></i>
                  <span id="fileName"></span>
                  <span class="remove-file" id="removeFile" title="Remove file">&times;</span>
                </div>
              </div>
              <div class="file-progress" id="fileProgress">
                <div class="progress progress-sm">
                  <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                       id="fileProgressBar" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="fileProgressText">Uploading...</small>
              </div>

              <!-- Input -->
              <div class="chat-input-bar">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <button class="btn btn-outline-secondary" id="attachBtn" title="Upload a file to this conversation">
                      <i class="fas fa-paperclip"></i>
                    </button>
                  </div>
                  <input type="text" id="chatInput" class="form-control"
                         placeholder="Type your message‚Ä¶" autocomplete="off">
                  <div class="input-group-append">
                    <button class="btn btn-primary" id="sendBtn">
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </div>
                </div>
                <input type="file" id="fileInput" style="display:none"
                       accept=".pdf,.txt,.doc,.docx,.pptx,.xlsx,.csv,.json,.xml">
              </div>
            </div>
          </div>
        </div>
      </div>



    </div>
  </div>
</section>
</div><!-- /.claire-page -->

<!-- Markdown libs -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/json.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/sql.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

<script>
(function () {
  var chatMessages = document.getElementById('chatMessages');
  var chatInput = document.getElementById('chatInput');
  var sendBtn = document.getElementById('sendBtn');
  var typingIndicator = document.getElementById('typingIndicator');
  var attachBtn = document.getElementById('attachBtn');
  var fileInput = document.getElementById('fileInput');
  var fileUploadArea = document.getElementById('fileUploadArea');
  var fileNameEl = document.getElementById('fileName');
  var removeFileBtn = document.getElementById('removeFile');
  var fileProgress = document.getElementById('fileProgress');
  var fileProgressBar = document.getElementById('fileProgressBar');
  var fileProgressText = document.getElementById('fileProgressText');
  var emptyState = document.getElementById('emptyState');
  var currentConversationId = {{ conversation.pk }};
  var pendingFile = null;

  // Configure marked for markdown rendering
  if (typeof marked !== 'undefined') {
    marked.setOptions({
      breaks: true,
      gfm: true,
      highlight: function(code, lang) {
        if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
          try { return hljs.highlight(code, {language: lang}).value; } catch(e) {}
        }
        return code;
      }
    });
  }

  function renderMarkdown(text) {
    if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
      try {
        return DOMPurify.sanitize(marked.parse(text));
      } catch(e) {
        return escapeHtml(text);
      }
    }
    return escapeHtml(text);
  }

  function escapeHtml(text) {
    var d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function removeEmptyState() {
    if (emptyState) { emptyState.remove(); emptyState = null; }
  }

  function appendBubble(role, content, isHtml) {
    removeEmptyState();
    var bubble = document.createElement('div');
    bubble.className = 'chat-bubble ' + role;

    if (role === 'system') {
      bubble.innerHTML = '<div class="bubble-content">' + renderMarkdown(content) + '</div>';
    } else {
      var avatarIcon = role === 'user' ? 'user' : 'robot';
      bubble.innerHTML =
        '<div class="avatar"><i class="fas fa-' + avatarIcon + '"></i></div>' +
        '<div class="bubble-content"></div>';
      if (role === 'assistant' || isHtml) {
        bubble.querySelector('.bubble-content').innerHTML = renderMarkdown(content);
      } else {
        bubble.querySelector('.bubble-content').textContent = content;
      }
    }
    chatMessages.insertBefore(bubble, typingIndicator);
    scrollToBottom();
    return bubble;
  }

  function createStreamBubble() {
    removeEmptyState();
    var bubble = document.createElement('div');
    bubble.className = 'chat-bubble assistant';
    bubble.innerHTML =
      '<div class="avatar"><i class="fas fa-robot"></i></div>' +
      '<div class="bubble-content"></div>';
    chatMessages.insertBefore(bubble, typingIndicator);
    scrollToBottom();
    return bubble;
  }

  // File upload handling
  attachBtn.addEventListener('click', function() { fileInput.click(); });

  fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) {
      pendingFile = fileInput.files[0];
      fileNameEl.textContent = pendingFile.name;
      fileUploadArea.style.display = 'flex';
    }
  });

  removeFileBtn.addEventListener('click', function() {
    pendingFile = null;
    fileInput.value = '';
    fileUploadArea.style.display = 'none';
  });

  function uploadFile(file) {
    return new Promise(function(resolve, reject) {
      fileProgress.style.display = 'block';
      fileProgressBar.style.width = '0%';
      fileProgressText.textContent = 'Uploading ' + file.name + '...';

      var formData = new FormData();
      formData.append('file', file);
      formData.append('conversation_id', currentConversationId);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', '{% url "claire-session-upload" %}');

      xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          var pct = Math.round((e.loaded / e.total) * 100);
          fileProgressBar.style.width = pct + '%';
          fileProgressText.textContent = 'Uploading ' + file.name + '... ' + pct + '%';
        }
      };

      xhr.onload = function() {
        fileProgress.style.display = 'none';
        fileUploadArea.style.display = 'none';
        pendingFile = null;
        fileInput.value = '';

        if (xhr.status === 200) {
          var data = JSON.parse(xhr.responseText);
          // Add system message about the upload
          appendBubble('system', 'üìé File uploaded: **' + data.filename + '** (' + data.chunks + ' chunks indexed)');
          resolve(data);
        } else {
          var err = 'Upload failed';
          try { err = JSON.parse(xhr.responseText).error || err; } catch(e) {}
          appendBubble('system', '‚ö†Ô∏è ' + err);
          reject(err);
        }
      };

      xhr.onerror = function() {
        fileProgress.style.display = 'none';
        reject('Network error');
      };

      xhr.send(formData);
    });
  }

  function getFileIcon(filename) {
    var ext = filename.split('.').pop().toLowerCase();
    var iconMap = {
      'pdf':  'fa-file-pdf icon-pdf',
      'doc':  'fa-file-word icon-word',
      'docx': 'fa-file-word icon-word',
      'xls':  'fa-file-excel icon-excel',
      'xlsx': 'fa-file-excel icon-excel',
      'ppt':  'fa-file-powerpoint icon-ppt',
      'pptx': 'fa-file-powerpoint icon-ppt',
      'csv':  'fa-file-csv icon-csv',
      'json': 'fa-file-code icon-code',
      'xml':  'fa-file-code icon-code',
      'txt':  'fa-file-alt icon-text',
      'md':   'fa-file-alt icon-text',
      'jpg':  'fa-file-image icon-image',
      'jpeg': 'fa-file-image icon-image',
      'png':  'fa-file-image icon-image',
      'gif':  'fa-file-image icon-image'
    };
    return iconMap[ext] || 'fa-file icon-text';
  }

  function sendMessage() {
    var msg = chatInput.value.trim();
    if (!msg && !pendingFile) return;
    chatInput.value = '';
    sendBtn.disabled = true;

    // Handle file upload first
    if (pendingFile) {
      var fileToUpload = pendingFile;
      uploadFile(fileToUpload).then(function() {
        if (msg) { doSendText(msg); }
        else { sendBtn.disabled = false; chatInput.focus(); }
      }).catch(function() {
        if (msg) { doSendText(msg); }
        else { sendBtn.disabled = false; chatInput.focus(); }
      });
      return;
    }

    doSendText(msg);
  }

  function doSendText(msg) {
    appendBubble('user', msg);
    typingIndicator.style.display = 'flex';
    scrollToBottom();

    // Use SSE streaming
    var streamBubble = null;
    var fullContent = '';

    fetch('{% url "claire-ask" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        message: msg,
        conversation_id: currentConversationId,
        stream: true
      })
    }).then(function(response) {
      typingIndicator.style.display = 'none';

      if (!response.ok) {
        return response.json().then(function(d) {
          appendBubble('assistant', 'Error: ' + (d.error || 'Unknown error'));
          sendBtn.disabled = false;
          chatInput.focus();
        });
      }

      var reader = response.body.getReader();
      var decoder = new TextDecoder();
      var buffer = '';

      function processStream() {
        return reader.read().then(function(result) {
          if (result.done) {
            if (!streamBubble && fullContent) {
              appendBubble('assistant', fullContent);
            } else if (streamBubble) {
              streamBubble.querySelector('.bubble-content').innerHTML = renderMarkdown(fullContent);
            }
            sendBtn.disabled = false;
            chatInput.focus();
            return;
          }

          buffer += decoder.decode(result.value, {stream: true});
          var lines = buffer.split('\n');
          buffer = lines.pop();

          for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (!line.startsWith('data: ')) continue;
            var jsonStr = line.substring(6);
            try {
              var data = JSON.parse(jsonStr);
              if (data.type === 'start') {
                streamBubble = createStreamBubble();
              } else if (data.type === 'token') {
                fullContent += data.content;
                if (streamBubble) {
                  streamBubble.querySelector('.bubble-content').innerHTML = renderMarkdown(fullContent);
                  scrollToBottom();
                }
              } else if (data.type === 'done') {
                currentConversationId = data.conversation_id || currentConversationId;
                if (streamBubble) {
                  streamBubble.querySelector('.bubble-content').innerHTML = renderMarkdown(fullContent);
                }
                sendBtn.disabled = false;
                chatInput.focus();
                return;
              }
            } catch(e) {
              // Ignore parse errors for incomplete chunks
            }
          }

          return processStream();
        });
      }

      return processStream();
    }).catch(function(err) {
      typingIndicator.style.display = 'none';
      appendBubble('assistant', 'Network error. Please try again.');
      sendBtn.disabled = false;
      chatInput.focus();
    });
  }

  sendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  // Render existing assistant messages as markdown
  document.querySelectorAll('.chat-bubble.assistant .bubble-content').forEach(function(el) {
    if (el.closest('#typingIndicator')) return;
    var raw = el.textContent;
    el.innerHTML = renderMarkdown(raw);
  });

  scrollToBottom();
  chatInput.focus();
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Midnight Auto-Reset ‚Äî Countdown & Auto-Refresh
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function setupMidnightRefresh() {
  var countdownEl = document.getElementById('countdownText');
  var countdownContainer = document.getElementById('midnightCountdown');

  function getMsUntilMidnight() {
    var now = new Date();
    var midnight = new Date(now);
    midnight.setHours(24, 0, 0, 0);
    return midnight.getTime() - now.getTime();
  }

  function formatTime(ms) {
    var totalSec = Math.floor(ms / 1000);
    var h = Math.floor(totalSec / 3600);
    var m = Math.floor((totalSec % 3600) / 60);
    var s = totalSec % 60;
    if (h > 0) return h + 'h ' + m + 'm ' + s + 's';
    if (m > 0) return m + 'm ' + s + 's';
    return s + 's';
  }

  function updateCountdown() {
    var ms = getMsUntilMidnight();
    if (countdownEl) {
      countdownEl.textContent = 'Fresh chat in ' + formatTime(ms);
    }
    return ms;
  }

  function checkMidnightReset() {
    var ms = updateCountdown();

    // Show countdown when less than 5 minutes remain
    if (ms <= 300000 && countdownContainer) {
      countdownContainer.style.display = 'block';
    }

    if (ms <= 1000) {
      // Midnight reached ‚Äî show alert and reload
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          title: 'New Day, Fresh Chat!',
          text: 'It\'s midnight ‚Äî starting a fresh conversation for you.',
          icon: 'info',
          timer: 3000,
          showConfirmButton: false,
          allowOutsideClick: false,
        }).then(function() {
          window.location.href = '{% url "claire-assistant" %}';
        });
      } else {
        window.location.href = '{% url "claire-assistant" %}';
      }
      return;
    }

    // Schedule next check
    var nextCheck = ms <= 60000 ? 1000 : 60000;
    setTimeout(checkMidnightReset, nextCheck);
  }

  checkMidnightReset();
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// New Chat, Delete & Clear History
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// New Chat Button
var newChatBtn = document.getElementById('newChatBtn');
if (newChatBtn) {
  newChatBtn.addEventListener('click', function() {
    window.location.href = '{% url "claire-assistant" %}?new=1';
  });
}

// Delete Single Conversation
function deleteConversation(conversationId) {
  var confirmDelete = typeof Swal !== 'undefined'
    ? Swal.fire.bind(Swal)
    : function(opts) { return Promise.resolve({value: confirm(opts.title)}); };

  confirmDelete({
    title: 'Delete Conversation?',
    text: 'This will permanently delete this conversation and its messages.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'Delete!',
  }).then(function(result) {
    if (!result.value) return;

    var formData = new FormData();
    formData.append('conv_id', conversationId);

    fetch('{% url "claire-delete-conversation" %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: formData,
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.status === 'ok') {
        // Remove from sidebar DOM
        var items = document.querySelectorAll('.conversation-item[data-conv-id="' + conversationId + '"]');
        items.forEach(function(el) { el.remove(); });
        // If deleted was current, redirect to fresh chat
        if (conversationId == {{ current_conv_id|default:"0" }}) {
          window.location.href = '{% url "claire-assistant" %}';
        }
      } else {
        alert(data.message || 'Failed to delete.');
      }
    })
    .catch(function() { alert('Network error.'); });
  });
}

// Clear All History
var clearHistoryBtn = document.getElementById('clearHistoryBtn');
if (clearHistoryBtn) {
  clearHistoryBtn.addEventListener('click', function() {
    var confirmClear = typeof Swal !== 'undefined'
      ? Swal.fire.bind(Swal)
      : function(opts) { return Promise.resolve({value: confirm(opts.title)}); };

    confirmClear({
      title: 'Clear All Chat History?',
      text: 'This will permanently delete ALL your conversations.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'Clear All!',
    }).then(function(result) {
      if (!result.value) return;

      fetch('{% url "claire-clear-history" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.status === 'ok') {
          window.location.href = data.redirect_url || '{% url "claire-assistant" %}';
        } else {
          alert(data.message || 'Failed to clear history.');
        }
      })
      .catch(function() { alert('Network error.'); });
    });
  });
}
</script>
<!-- SweetAlert2 for midnight popup (optional ‚Äî works without it too) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
{% endblock %}
