{% extends "administrator/base.html" %}
{% load static %}

{% block body %}
<!-- Content Header -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0 text-dark">
          <i class="fas fa-history text-info mr-2"></i>Claire History
        </h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'admin-dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item active">Claire History</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">

    <!-- Stat Box -->
    <div class="row">
      <div class="col-lg-4 col-6">
        <div class="small-box bg-info">
          <div class="inner">
            <h3>{{ total_count }}</h3>
            <p>Total Conversations</p>
          </div>
          <div class="icon"><i class="fas fa-comments"></i></div>
          <a href="{% url 'claire-assistant' %}" class="small-box-footer">
            New Chat <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible">
      <button type="button" class="close" data-dismiss="alert">&times;</button>
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <!-- Conversations Table -->
    <div class="card card-primary card-outline">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-list mr-2"></i>All Conversations</h3>
        <div class="card-tools">
          <a href="{% url 'claire-assistant' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus mr-1"></i> New Chat
          </a>
        </div>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped table-hover">
          <thead class="thead-light">
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>User</th>
              <th>Messages</th>
              <th>Last Activity</th>
              <th>Started</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for conv in conversations %}
            <tr>
              <td>{{ conv.pk }}</td>
              <td>
                <a href="{% url 'claire-conversation-detail' conv.pk %}">
                  <strong>{{ conv.title|default:"Untitled" }}</strong>
                </a>
              </td>
              <td>{{ conv.user.email }}</td>
              <td>
                <span class="badge badge-info">{{ conv.message_count }}</span>
              </td>
              <td>{{ conv.updated_at|date:"M d, Y H:i" }}</td>
              <td>{{ conv.created_at|date:"M d, Y" }}</td>
              <td>
                <a href="{% url 'claire-conversation-detail' conv.pk %}"
                   class="btn btn-info btn-xs mr-1" title="View">
                  <i class="fas fa-eye"></i>
                </a>
                <button type="button"
                        class="btn btn-danger btn-xs btn-delete-conv"
                        data-url="{% url 'claire-conversation-delete' conv.pk %}"
                        data-token="{{ csrf_token }}"
                        title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                No conversations yet.
                <a href="{% url 'claire-assistant' %}">Start chatting with Claire</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if conversations.has_other_pages %}
      <div class="card-footer clearfix">
        <ul class="pagination pagination-sm m-0 float-right">
          {% if conversations.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ conversations.previous_page_number }}">«</a>
          </li>
          {% endif %}
          <li class="page-item active">
            <span class="page-link">{{ conversations.number }} / {{ conversations.paginator.num_pages }}</span>
          </li>
          {% if conversations.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ conversations.next_page_number }}">»</a>
          </li>
          {% endif %}
        </ul>
      </div>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}

{% block script %}
$(document).on('click', '.btn-delete-conv', function () {
  var btn = $(this);
  var url = btn.data('url');
  var token = btn.data('token');
  var row = btn.closest('tr');

  Swal.fire({
    title: 'Do you really want to delete this record',
    text: 'This process cannot be undone.',
    type: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#999999',
    confirmButtonText: 'Delete!',
    cancelButtonText: 'Cancel'
  }).then(function (result) {
    if (result.value) {
      $.ajax({
        url: url,
        method: 'POST',
        data: { csrfmiddlewaretoken: token },
        success: function () {
          row.fadeOut(300, function () { $(this).remove(); });
          Swal.fire('Deleted', '', 'success');
        },
        error: function () {
          Swal.fire('Error', 'Could not delete. Please try again.', 'error');
        }
      });
    } else if (result.dismiss === Swal.DismissReason.cancel) {
      Swal.fire('Cancelled', '', 'error');
    }
  });
});
{% endblock %}
