{% load static %}
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<!-- jQuery UI 1.11.4 -->
<script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<!-- Bootstrap 4 -->
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- ChartJS -->
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<!-- Sparkline -->
<script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
<!-- JQVMap -->
<script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
<script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
<!-- jQuery Knob Chart -->
<script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
<!-- daterangepicker -->
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<!-- Summernote -->
<script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
<!-- overlayScrollbars -->
<script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'admin-assets/js/adminlte.js' %}"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="{% static 'admin-assets/js/pages/dashboard.js' %}"></script>
<!-- DataTables  & Plugins -->
<script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
<script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
<script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
<!--data table-->
<script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
<!--chart-->
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<!--sweetalert-->
<script src="{% static 'plugins/sweet-alert2/sweetalert2.min.js' %}"></script>
<script src="{% static 'plugins/alertify/js/alertify.js' %}"></script>
<script src="{% static 'plugins/json-viewer/json-viewer.js' %}"></script>
{% include "elements/message.html" %}


<script>
  $(document).on('click','.remove_record', function(){
        console.log('on delete')
         var text = 'Do you really want to delete this record';
         Swal.fire({
           title: text,
           text: 'This process cannot be undone.',
           type: 'warning',
           showCancelButton: true,
           confirmButtonColor: '#d33',
           cancelButtonColor: '#999999',
           confirmButtonText: 'Delete!',
           cancelButtonText: 'Cancel'
         }).then((result) => {
           if (result.value) {
             var url = $(this).data("url")
             $.ajax({        // initialize an AJAX request
                        url: url,
                        data: $('#model-form-delete').serialize(),
                        method: 'POST',
                        success: function (data) {
                          oTable.ajax.reload( function(settings, json){
                                        $('#id_count').html(settings.recordsTotal);
                                    }, false );
                          Swal.fire(
                               'Deleted',
                               '',
                               'success'
                             )
                        }
              });


           } else if (result.dismiss === Swal.DismissReason.cancel) {
             Swal.fire(
               'Cancelled',
               '',
               'error'
             )
           }
         })
     });

    var ajaxUrl = $('#list_page_url').val();
    var oTable = $('#datatable').DataTable({
          "pageLength":10,
          "serverSide": true,

          "ordering": true,
              columnDefs: [{
              "width": "20%",
              orderable: false,
              targets: "no-sort"
              }],
          "language": {
          "emptyTable": "No data available"
           },
          "order": [],
          "ajax": { "url": ajaxUrl },
          "scrollX": true,
          "initComplete": function(settings, json){
                $('#id_count').html(settings.json.recordsTotal);
           },
           "columnDefs": [{
                "targets": [-1],
                "orderable": false,
                "className": 'text-right'
            }],
    });
</script>

{% if user.is_authenticated %}
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CLAIRE CHAT WIDGET â€” inject user/CSRF data for JS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
window.claireWidgetData = {
    isAuthenticated: true,
    userId: {{ user.pk }},
    userName: "{{ user.get_full_name|default:user.username|escapejs }}",
    csrfToken: "{{ csrf_token }}",
    askUrl: "{% url 'claire-ask' %}",
    uploadUrl: "{% url 'claire-session-upload' %}",
    historyUrl: "{% url 'claire-history' %}",
    assistantUrl: "{% url 'claire-assistant' %}",
};
</script>

<!-- marked.js for Markdown rendering in the widget -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
<!-- DOMPurify for safe HTML -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

<!-- â”€â”€ Widget HTML â”€â”€ -->
<div id="claireWidget">
  <!-- Toggle button -->
  <button id="claireToggleBtn" title="Chat with Claire" aria-label="Open Claire chat">
    <i class="fas fa-robot" id="claireToggleIcon"></i>
    <span class="claire-notif-dot" id="claireNotifDot" style="display:none;"></span>
  </button>

  <!-- Chat window -->
  <div id="claireWindow" class="claire-window" style="display:none;" role="dialog" aria-label="Claire AI Chat">
    <!-- Header -->
    <div class="claire-header">
      <div class="claire-header-info">
        <div class="claire-avatar"><i class="fas fa-robot"></i></div>
        <div>
          <div class="claire-title">Claire</div>
          <div class="claire-subtitle" id="claireStatus">AI Assistant Â· Online</div>
        </div>
      </div>
      <div class="claire-header-btns">
        <a href="{% url 'claire-assistant' %}" class="claire-hdr-btn" title="Open full chat" target="_self">
          <i class="fas fa-external-link-alt"></i>
        </a>
        <button class="claire-hdr-btn" id="claireCloseBtn" title="Close" aria-label="Close chat">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div class="claire-messages" id="claireMessages" role="log" aria-live="polite">
      <!-- Populated by JS -->
    </div>

    <!-- File upload status bar -->
    <div class="claire-upload-bar" id="claireUploadBar" style="display:none;">
      <i class="fas fa-paperclip"></i>
      <span id="claireUploadName" class="claire-upload-name"></span>
      <button id="claireRemoveFile" class="claire-remove-file" title="Remove file">&times;</button>
    </div>
    <div id="claireUploadProgress" style="display:none;padding:0 12px 6px;">
      <div style="height:3px;background:#e9ecef;border-radius:2px;">
        <div id="claireProgressBar" style="height:100%;width:0%;background:#007bff;border-radius:2px;transition:width 0.2s;"></div>
      </div>
    </div>

    <!-- Input -->
    <div class="claire-footer">
      <button id="claireAttachBtn" class="claire-attach-btn" title="Upload file">
        <i class="fas fa-paperclip"></i>
      </button>
      <input type="file" id="claireFileInput" style="display:none;"
             accept=".pdf,.txt,.doc,.docx,.pptx,.xlsx,.csv,.json,.xml,.png,.jpg,.jpeg">
      <textarea id="claireInput" class="claire-input" rows="1"
                placeholder="Ask Claire anythingâ€¦" aria-label="Message input"></textarea>
      <button id="claireSendBtn" class="claire-send-btn" title="Send" aria-label="Send message">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>

    <!-- Resize handle â€” top-left corner -->
    <div id="claireResizeHandle" class="claire-resize-handle" title="Drag to resize">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M1 13L13 1M7 13L13 7M1 7L7 1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
    </div>
  </div>
</div>

<!-- â”€â”€ Widget CSS â”€â”€ -->
<style>
/* ==== Floating toggle button ==== */
#claireWidget {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 99999;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
#claireToggleBtn {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,123,255,0.4);
  color: #fff;
  font-size: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
}
#claireToggleBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0,123,255,0.5); }
.claire-notif-dot {
  position: absolute;
  top: 4px; right: 4px;
  width: 10px; height: 10px;
  background: #dc3545;
  border-radius: 50%;
  border: 2px solid #fff;
  animation: clairePulse 2s infinite;
}
@keyframes clairePulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.3);opacity:0.7} }

/* ==== Chat window ==== */
.claire-window {
  position: absolute;
  bottom: 68px;
  right: 0;
  width: 380px;
  height: 540px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.18);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: claireSlideIn 0.25s ease;
  border: 1px solid #e9ecef;
}
@keyframes claireSlideIn {
  from { opacity:0; transform:translateY(12px) scale(0.97); }
  to   { opacity:1; transform:translateY(0)   scale(1); }
}

/* Header */
.claire-header {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.claire-header-info { display: flex; align-items: center; gap: 10px; }
.claire-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(255,255,255,0.2);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; color: #fff;
}
.claire-title { font-weight: 600; font-size: 15px; color: #fff; }
.claire-subtitle { font-size: 11px; color: rgba(255,255,255,0.8); }
.claire-header-btns { display: flex; gap: 6px; }
.claire-hdr-btn {
  background: rgba(255,255,255,0.15);
  border: none;
  color: #fff;
  width: 28px; height: 28px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  display: flex; align-items: center; justify-content: center;
  text-decoration: none;
  transition: background 0.15s;
}
.claire-hdr-btn:hover { background: rgba(255,255,255,0.3); color: #fff; }

/* Messages */
.claire-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: #f8f9fa;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.claire-messages::-webkit-scrollbar { width: 4px; }
.claire-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

/* Bubbles */
.claire-bubble-wrap {
  display: flex;
  align-items: flex-end;
  gap: 6px;
}
.claire-bubble-wrap.user  { flex-direction: row-reverse; }
.claire-bubble-wrap.assistant { flex-direction: row; }
.claire-bubble-wrap.system { justify-content: center; }

.claire-bubble-icon {
  width: 26px; height: 26px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; flex-shrink: 0; margin-bottom: 2px;
}
.claire-bubble-wrap.user .claire-bubble-icon    { background: #007bff; color: #fff; }
.claire-bubble-wrap.assistant .claire-bubble-icon { background: #17a2b8; color: #fff; }

.claire-bubble {
  max-width: 82%;
  padding: 9px 13px;
  border-radius: 16px;
  font-size: 0.88rem;
  line-height: 1.55;
  word-break: break-word;
}
.claire-bubble-wrap.user .claire-bubble {
  background: #007bff; color: #fff;
  border-bottom-right-radius: 4px;
}
.claire-bubble-wrap.assistant .claire-bubble {
  background: #fff; color: #333;
  border: 1px solid #e9ecef;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.claire-bubble-wrap.system .claire-bubble {
  background: #e8f5e9; color: #2e7d32; font-size: 0.78rem;
  border-radius: 8px; max-width: 95%; text-align: center;
}

/* Markdown inside bubbles */
.claire-bubble p { margin: 0 0 6px 0; }
.claire-bubble p:last-child { margin-bottom: 0; }
.claire-bubble ul, .claire-bubble ol { padding-left: 18px; margin: 4px 0; }
.claire-bubble li { margin: 2px 0; }
.claire-bubble pre { background: #1e1e1e; color: #d4d4d4; padding: 8px; border-radius: 6px; overflow-x: auto; font-size: 0.8rem; margin: 6px 0; }
.claire-bubble code { background: #e9ecef; padding: 1px 4px; border-radius: 3px; font-size: 0.83em; }
.claire-bubble pre code { background: none; padding: 0; color: inherit; }
.claire-bubble.claire-bubble-wrap.user p code { background: rgba(255,255,255,0.2); }
.claire-bubble strong { font-weight: 600; }
.claire-bubble h1,.claire-bubble h2,.claire-bubble h3 { font-size: 1em; font-weight: 700; margin: 8px 0 4px; }

/* Typing indicator */
.claire-typing {
  display: flex; gap: 4px; align-items: center;
  padding: 9px 13px;
  background: #fff; border: 1px solid #e9ecef;
  border-radius: 16px; border-bottom-left-radius: 4px;
  width: fit-content;
}
.claire-typing span {
  width: 6px; height: 6px; border-radius: 50%;
  background: #aaa; display: inline-block;
  animation: claireTypingBounce 1.2s infinite;
}
.claire-typing span:nth-child(2) { animation-delay: 0.2s; }
.claire-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes claireTypingBounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-5px)} }

/* Welcome message */
.claire-welcome {
  text-align: center; padding: 20px 10px;
}
.claire-welcome i { font-size: 40px; color: #17a2b8; margin-bottom: 10px; }
.claire-welcome p { font-size: 0.85rem; color: #666; margin: 4px 0; }
.claire-welcome .claire-welcome-name { font-weight: 600; color: #333; font-size: 0.95rem; }

/* File upload bar */
.claire-upload-bar {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 14px; background: #e8f5e9;
  font-size: 0.8rem; color: #2e7d32; flex-shrink: 0;
}
.claire-upload-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.claire-remove-file {
  background: none; border: none; color: #dc3545;
  font-size: 1rem; cursor: pointer; padding: 0 2px; line-height: 1;
}

/* Footer input area */
.claire-footer {
  display: flex; align-items: flex-end; gap: 6px;
  padding: 10px 12px;
  border-top: 1px solid #e9ecef;
  background: #fff;
  flex-shrink: 0;
}
.claire-attach-btn {
  background: none; border: none; color: #6c757d;
  font-size: 15px; cursor: pointer; padding: 6px;
  border-radius: 8px; flex-shrink: 0;
  transition: background 0.15s, color 0.15s;
}
.claire-attach-btn:hover { background: #e9ecef; color: #333; }
.claire-input {
  flex: 1; border: 1px solid #dee2e6; border-radius: 20px;
  padding: 8px 14px; font-size: 0.87rem; line-height: 1.4;
  resize: none; outline: none; max-height: 100px; overflow-y: auto;
  background: #f8f9fa; transition: border-color 0.15s;
  font-family: inherit;
}
.claire-input:focus { border-color: #007bff; background: #fff; }
.claire-send-btn {
  background: #007bff; color: #fff; border: none;
  width: 36px; height: 36px; border-radius: 50%;
  font-size: 13px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, transform 0.1s;
}
.claire-send-btn:hover { background: #0056b3; transform: scale(1.05); }
.claire-send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

/* ==== Resize handle â€” top-left corner ==== */
.claire-resize-handle {
  position: absolute;
  top: 0;
  left: 0;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: nwse-resize;
  color: rgba(255,255,255,0.7);
  background: transparent;
  border-radius: 0 0 8px 0;
  transition: color 0.15s, background 0.15s;
  z-index: 10;
  user-select: none;
}
.claire-resize-handle:hover {
  color: #fff;
  background: rgba(0,0,0,0.12);
}
.claire-window.claire-resizing {
  user-select: none;
  transition: none !important;
}

/* Mobile adjustments */
@media (max-width: 480px) {
  .claire-window { width: calc(100vw - 20px); right: -4px; height: 480px; border-radius: 12px; }
  #claireWidget { bottom: 16px; right: 12px; }
  .claire-resize-handle { display: none; }
}
</style>

<!-- â”€â”€ Widget JavaScript â”€â”€ -->
<script>
(function () {
  'use strict';
  if (window.__claireWidgetLoaded) return;
  window.__claireWidgetLoaded = true;

  var DATA = window.claireWidgetData || {};
  var STORAGE_KEY = 'claire_widget_v1_u' + (DATA.userId || '0');

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var state = {
    isOpen: false,
    conversationId: null,
    pendingFile: null,
    isLoading: false,
    messages: [],   // {role, content, time}
  };

  // â”€â”€ DOM refs (loaded once window.onload fires)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var $widget, $window, $messages, $input, $sendBtn,
      $attachBtn, $fileInput, $uploadBar, $uploadName,
      $removeFile, $uploadProgress, $progressBar,
      $toggleBtn, $closeBtn, $notifDot;

  function $(id) { return document.getElementById(id); }

  function init() {
    $widget       = document.getElementById('claireWidget');
    $window       = document.getElementById('claireWindow');
    $messages     = document.getElementById('claireMessages');
    $input        = document.getElementById('claireInput');
    $sendBtn      = document.getElementById('claireSendBtn');
    $attachBtn    = document.getElementById('claireAttachBtn');
    $fileInput    = document.getElementById('claireFileInput');
    $uploadBar    = document.getElementById('claireUploadBar');
    $uploadName   = document.getElementById('claireUploadName');
    $removeFile   = document.getElementById('claireRemoveFile');
    $uploadProgress = document.getElementById('claireUploadProgress');
    $progressBar  = document.getElementById('claireProgressBar');
    $toggleBtn    = document.getElementById('claireToggleBtn');
    $closeBtn     = document.getElementById('claireCloseBtn');
    $notifDot     = document.getElementById('claireNotifDot');

    // Restore state
    loadState();

    // Bind events
    $toggleBtn.addEventListener('click', toggleWidget);
    $closeBtn.addEventListener('click', closeWidget);
    $sendBtn.addEventListener('click', sendMessage);
    $input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    $input.addEventListener('input', autoResizeInput);
    $attachBtn.addEventListener('click', function () { $fileInput.click(); });
    $fileInput.addEventListener('change', onFileSelected);
    $removeFile.addEventListener('click', removePendingFile);
  }

  // â”€â”€ Widget open/close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleWidget() {
    if (state.isOpen) { closeWidget(); } else { openWidget(); }
  }

  function openWidget() {
    $window.style.display = 'flex';
    state.isOpen = true;
    $notifDot.style.display = 'none';
    document.getElementById('claireToggleIcon').className = 'fas fa-times';

    if (state.messages.length === 0) {
      showWelcome();
    } else {
      renderAllMessages();
    }
    scrollBottom();
    $input.focus();
    saveState();
  }

  function closeWidget() {
    $window.style.display = 'none';
    state.isOpen = false;
    document.getElementById('claireToggleIcon').className = 'fas fa-robot';
    saveState();
  }

  // â”€â”€ Welcome screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showWelcome() {
    $messages.innerHTML = '<div class="claire-welcome">' +
      '<i class="fas fa-robot"></i>' +
      '<p class="claire-welcome-name">Hi, ' + (DATA.userName || 'there') + '!</p>' +
      '<p>I\'m Claire, your AI assistant.</p>' +
      '<p>Ask me anything or upload a file to get started.</p>' +
      '</div>';
  }

  // â”€â”€ Render messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderAllMessages() {
    $messages.innerHTML = '';
    state.messages.forEach(function (m) { appendBubbleDOM(m.role, m.content); });
  }

  function appendBubbleDOM(role, content) {
    var wrap = document.createElement('div');
    wrap.className = 'claire-bubble-wrap ' + role;

    if (role === 'system') {
      wrap.innerHTML = '<div class="claire-bubble">' + renderMd(content) + '</div>';
    } else {
      var icon = role === 'user'
        ? '<div class="claire-bubble-icon"><i class="fas fa-user"></i></div>'
        : '<div class="claire-bubble-icon"><i class="fas fa-robot"></i></div>';
      var bubble = '<div class="claire-bubble">' + (role === 'user' ? esc(content) : renderMd(content)) + '</div>';
      wrap.innerHTML = (role === 'user') ? bubble + icon : icon + bubble;
    }
    $messages.appendChild(wrap);
    return wrap;
  }

  function createStreamingBubble() {
    var wrap = document.createElement('div');
    wrap.className = 'claire-bubble-wrap assistant';
    wrap.innerHTML =
      '<div class="claire-bubble-icon"><i class="fas fa-robot"></i></div>' +
      '<div class="claire-bubble" id="claireStreamBubble"></div>';
    $messages.appendChild(wrap);
    return document.getElementById('claireStreamBubble');
  }

  // â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showTyping() {
    var wrap = document.createElement('div');
    wrap.className = 'claire-bubble-wrap assistant';
    wrap.id = 'claireTypingWrap';
    wrap.innerHTML =
      '<div class="claire-bubble-icon"><i class="fas fa-robot"></i></div>' +
      '<div class="claire-typing"><span></span><span></span><span></span></div>';
    $messages.appendChild(wrap);
    scrollBottom();
  }

  function hideTyping() {
    var el = document.getElementById('claireTypingWrap');
    if (el) el.remove();
  }

  // â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sendMessage() {
    var msg = $input.value.trim();
    if ((!msg && !state.pendingFile) || state.isLoading) return;
    $input.value = '';
    autoResizeInput();
    state.isLoading = true;
    $sendBtn.disabled = true;

    // Clear welcome screen
    var welcome = $messages.querySelector('.claire-welcome');
    if (welcome) welcome.remove();

    if (state.pendingFile) {
      var file = state.pendingFile;
      doUpload(file).then(function () {
        if (msg) { doSend(msg); }
        else { state.isLoading = false; $sendBtn.disabled = false; }
      }).catch(function () {
        if (msg) { doSend(msg); }
        else { state.isLoading = false; $sendBtn.disabled = false; }
      });
      return;
    }
    doSend(msg);
  }

  function doSend(msg) {
    // Add user bubble
    state.messages.push({ role: 'user', content: msg });
    appendBubbleDOM('user', msg);
    showTyping();
    scrollBottom();

    var fullContent = '';
    var streamBubble = null;

    fetch(DATA.askUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': DATA.csrfToken,
      },
      body: JSON.stringify({
        message: msg,
        conversation_id: state.conversationId,
        stream: true,
      }),
    })
    .then(function (res) {
      hideTyping();
      if (!res.ok) {
        return res.json().then(function (d) {
          addErrorBubble(d.error || 'Request failed');
          finishSend();
        });
      }
      var reader = res.body.getReader();
      var decoder = new TextDecoder();
      var buffer = '';

      function pump() {
        return reader.read().then(function (result) {
          if (result.done) { finishSend(); return; }
          buffer += decoder.decode(result.value, { stream: true });
          var lines = buffer.split('\n');
          buffer = lines.pop();

          for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (!line.startsWith('data: ')) continue;
            try {
              var data = JSON.parse(line.slice(6));
              if (data.type === 'start') {
                streamBubble = createStreamingBubble();
              } else if (data.type === 'token') {
                fullContent += data.content;
                if (streamBubble) {
                  streamBubble.innerHTML = renderMd(fullContent);
                  scrollBottom();
                }
              } else if (data.type === 'done') {
                state.conversationId = data.conversation_id || state.conversationId;
                if (streamBubble) streamBubble.innerHTML = renderMd(fullContent);
                state.messages.push({ role: 'assistant', content: fullContent });
                finishSend();
                saveState();
                return;
              }
            } catch (e) { /* skip malformed chunks */ }
          }
          return pump();
        });
      }
      return pump();
    })
    .catch(function () {
      hideTyping();
      addErrorBubble('Network error. Please try again.');
      finishSend();
    });
  }

  function finishSend() {
    state.isLoading = false;
    $sendBtn.disabled = false;
    $input.focus();
    scrollBottom();
    saveState();
  }

  function addErrorBubble(text) {
    appendBubbleDOM('system', 'âš ï¸ ' + text);
  }

  // â”€â”€ File upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function onFileSelected() {
    if (!$fileInput.files.length) return;
    var file = $fileInput.files[0];
    state.pendingFile = file;
    $uploadName.textContent = file.name;
    $uploadBar.style.display = 'flex';
  }

  function removePendingFile() {
    state.pendingFile = null;
    $fileInput.value = '';
    $uploadBar.style.display = 'none';
  }

  function doUpload(file) {
    return new Promise(function (resolve, reject) {
      $uploadProgress.style.display = 'block';
      $progressBar.style.width = '0%';

      var fd = new FormData();
      fd.append('file', file);
      if (state.conversationId) fd.append('conversation_id', state.conversationId);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', DATA.uploadUrl);
      xhr.setRequestHeader('X-CSRFToken', DATA.csrfToken);
      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) $progressBar.style.width = Math.round(e.loaded / e.total * 100) + '%';
      };
      xhr.onload = function () {
        $uploadProgress.style.display = 'none';
        $uploadBar.style.display = 'none';
        state.pendingFile = null;
        $fileInput.value = '';

        if (xhr.status === 200) {
          var d = JSON.parse(xhr.responseText);
          appendBubbleDOM('system', 'ðŸ“Ž Uploaded <strong>' + esc(d.filename || file.name) + '</strong> (' + (d.chunks || 0) + ' chunks indexed)');
          scrollBottom();
          resolve(d);
        } else {
          var err = 'Upload failed';
          try { err = JSON.parse(xhr.responseText).error || err; } catch (e) {}
          addErrorBubble(err);
          reject(err);
        }
      };
      xhr.onerror = function () {
        $uploadProgress.style.display = 'none';
        reject('Network error');
      };
      xhr.send(fd);
    });
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function scrollBottom() {
    $messages.scrollTop = $messages.scrollHeight;
  }

  function autoResizeInput() {
    $input.style.height = 'auto';
    $input.style.height = Math.min($input.scrollHeight, 100) + 'px';
  }

  function renderMd(text) {
    if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
      try { return DOMPurify.sanitize(marked.parse(text)); } catch (e) {}
    }
    var d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  function esc(text) {
    var d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  // â”€â”€ State persistence (sessionStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveState() {
    try {
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify({
        isOpen: state.isOpen,
        conversationId: state.conversationId,
        messages: state.messages.slice(-40),  // keep last 40 messages
      }));
    } catch (e) {}
  }

  function loadState() {
    try {
      var raw = sessionStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      var saved = JSON.parse(raw);
      state.conversationId = saved.conversationId || null;
      state.messages = saved.messages || [];
      if (saved.isOpen) { openWidget(); }
    } catch (e) {}
  }

  // â”€â”€ Resize (drag top-left handle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var RESIZE_KEY = 'claire_size_v1';
  var DEFAULT_W = 380, DEFAULT_H = 540;
  var MIN_W = 280, MIN_H = 320, MAX_W = 720, MAX_H = 860;

  function loadWindowSize() {
    try {
      var raw = localStorage.getItem(RESIZE_KEY);
      if (!raw) return;
      var s = JSON.parse(raw);
      if (s.w && s.h) applyWindowSize(s.w, s.h);
    } catch (e) {}
  }

  function saveWindowSize(w, h) {
    try { localStorage.setItem(RESIZE_KEY, JSON.stringify({ w: w, h: h })); } catch (e) {}
  }

  function applyWindowSize(w, h) {
    var win = document.getElementById('claireWindow');
    if (!win) return;
    win.style.width  = w + 'px';
    win.style.height = h + 'px';
  }

  function setupResize() {
    var handle = document.getElementById('claireResizeHandle');
    if (!handle) return;

    var startX, startY, startW, startH;

    function onMouseMove(e) {
      e.preventDefault();
      var dx = startX - e.clientX;   // dragging left  â†’ wider
      var dy = startY - e.clientY;   // dragging up    â†’ taller
      var newW = Math.min(MAX_W, Math.max(MIN_W, startW + dx));
      var newH = Math.min(MAX_H, Math.max(MIN_H, startH + dy));
      applyWindowSize(newW, newH);
    }

    function onMouseUp(e) {
      var win = document.getElementById('claireWindow');
      if (win) {
        win.classList.remove('claire-resizing');
        saveWindowSize(parseInt(win.style.width), parseInt(win.style.height));
      }
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      document.removeEventListener('touchmove', onTouchMove);
      document.removeEventListener('touchend', onMouseUp);
    }

    function onTouchMove(e) {
      if (e.touches.length) onMouseMove(e.touches[0]);
    }

    handle.addEventListener('mousedown', function (e) {
      e.preventDefault();
      var win = document.getElementById('claireWindow');
      if (!win) return;
      win.classList.add('claire-resizing');
      startX = e.clientX;
      startY = e.clientY;
      startW = win.offsetWidth;
      startH = win.offsetHeight;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });

    handle.addEventListener('touchstart', function (e) {
      e.preventDefault();
      var win = document.getElementById('claireWindow');
      if (!win || !e.touches.length) return;
      var t = e.touches[0];
      win.classList.add('claire-resizing');
      startX = t.clientX;
      startY = t.clientY;
      startW = win.offsetWidth;
      startH = win.offsetHeight;
      document.addEventListener('touchmove', onTouchMove, { passive: false });
      document.addEventListener('touchend', onMouseUp);
    }, { passive: false });
  }

  // â”€â”€ Boot after DOM is ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () { init(); loadWindowSize(); setupResize(); });
  } else {
    init(); loadWindowSize(); setupResize();
  }
})();
</script>
{% endif %}

