{% extends "administrator/base.html" %}
{% load static %}

{% block body %}
<!-- Inject Django data for React -->
<script>
window.__DASHBOARD__ = {
  usersCount: {{ users_count|default:"0" }},
  activeUsersCount: {{ active_users_count|default:"0" }},
  newUsersCount: {{ new_users_count|default:"0" }},
  inactiveUsersCount: {{ inactive_users_count|default:"0" }},
  plansCount: {{ plans_count|default:"0" }},
  activePlansCount: {{ active_plans_count|default:"0" }},
  activeSubsCount: {{ active_subs_count|default:"0" }},
  chartLabels: {{ chart_labels|safe }},
  chartValues: {{ chart_values|safe }},
  recentPlans: [
    {% for plan in recent_plans %}
    {
      id: {{ plan.pk }},
      name: "{{ plan.name|escapejs }}",
      price: "{{ plan.price }}",
      duration: "{{ plan.get_duration_days_display|escapejs }}",
      subscribers: {{ plan.subscriptions.count }},
      isActive: {% if plan.is_active %}true{% else %}false{% endif %},
      editUrl: "{% url 'admin-subscription-plan-edit' plan.pk %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  recentUsers: [
    {% for u in recent_users %}
    {
      id: {{ u.pk }},
      name: "{{ u.get_full_name|default:'-'|escapejs }}",
      email: "{{ u.email|escapejs }}",
      dateJoined: "{{ u.date_joined|date:'d M Y' }}",
      isActive: {% if u.is_active %}true{% else %}false{% endif %},
      detailUrl: "{% url 'admin-user-detail' u.pk %}",
      editUrl: "{% url 'admin-user-edit' u.pk %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  urls: {
    userList: "{% url 'admin-user-list' %}",
    userAdd: "{% url 'admin-user-add' %}",
    planList: "{% url 'admin-subscription-plan-list' %}",
    planAdd: "{% url 'admin-subscription-plan-add' %}",
  }
};
</script>

<!-- React mount point -->
<div id="nova-dashboard-root"></div>

<!-- React Dashboard App -->
<script type="text/babel">
{% verbatim %}
const { useState, useEffect, useRef, useCallback } = React;
const D = window.__DASHBOARD__;

/* ── Animated Counter Hook ── */
function useCounter(target, duration = 900) {
  const [val, setVal] = useState(0);
  useEffect(() => {
    if (!target) return;
    let start = 0;
    const step = 16;
    const inc = target / (duration / step);
    const timer = setInterval(() => {
      start += inc;
      if (start >= target) { start = target; clearInterval(timer); }
      setVal(Math.floor(start));
    }, step);
    return () => clearInterval(timer);
  }, [target, duration]);
  return val;
}

/* ── Stat Card Component ── */
function StatCard({ icon, value, label, gradient, bgIcon, link, delay = 0 }) {
  const count = useCounter(value);
  return (
    <a href={link} className="nova-stat-card" style={{
      background: gradient,
      animationDelay: `${delay}s`,
      animation: `fadeInUp 0.5s ease ${delay}s both`,
      textDecoration: 'none', color: '#fff'
    }}>
      <div className="stat-icon"><i className={`fas ${icon}`}></i></div>
      <div className="stat-number">{count.toLocaleString()}</div>
      <div className="stat-label">{label}</div>
      <div className="stat-footer"><i className="fas fa-arrow-right"></i> View details</div>
      <div className="stat-bg-icon"><i className={`fas ${bgIcon || icon}`}></i></div>
    </a>
  );
}

/* ── Chart Card Component ── */
function BarChartCard() {
  const canvasRef = useRef(null);
  useEffect(() => {
    if (!canvasRef.current || typeof Chart === 'undefined') return;
    const ctx = canvasRef.current.getContext('2d');
    const grad = ctx.createLinearGradient(0, 0, 0, 250);
    grad.addColorStop(0, 'rgba(79,142,247,0.85)');
    grad.addColorStop(1, 'rgba(99,102,241,0.15)');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: D.chartLabels,
        datasets: [{
          label: 'New Customers',
          data: D.chartValues,
          backgroundColor: grad,
          borderColor: 'rgba(79,142,247,1)',
          borderWidth: 2,
          borderRadius: 6,
          barThickness: 28,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        legend: { display: false },
        scales: {
          xAxes: [{ gridLines: { display: false }, ticks: { fontColor: '#94a3b8', fontSize: 11 } }],
          yAxes: [{ gridLines: { color: 'rgba(148,163,184,0.12)', drawBorder: false },
            ticks: { beginAtZero: true, precision: 0, fontColor: '#94a3b8', fontSize: 11 } }]
        },
        animation: { duration: 1200, easing: 'easeOutQuart' },
        tooltips: {
          backgroundColor: '#1e293b', titleFontColor: '#fff',
          bodyFontColor: '#cbd5e1', borderColor: '#334155',
          borderWidth: 1, cornerRadius: 8, xPadding: 12, yPadding: 10,
        }
      }
    });
  }, []);
  return (
    <div className="nova-chart-card">
      <div className="chart-header">
        <h3><i className="fas fa-chart-bar"></i> Monthly Customer Registrations</h3>
      </div>
      <div className="chart-body">
        <canvas ref={canvasRef} style={{ minHeight: '260px', height: '260px', maxHeight: '260px', maxWidth: '100%' }}></canvas>
      </div>
    </div>
  );
}

function DoughnutChartCard() {
  const canvasRef = useRef(null);
  useEffect(() => {
    if (!canvasRef.current || typeof Chart === 'undefined') return;
    new Chart(canvasRef.current.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Active', 'Inactive'],
        datasets: [{
          data: [D.activeUsersCount, D.inactiveUsersCount],
          backgroundColor: ['#4f8ef7', '#e2e8f0'],
          hoverBackgroundColor: ['#6366f1', '#cbd5e1'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutoutPercentage: 72,
        legend: {
          display: true, position: 'bottom',
          labels: { fontColor: '#64748b', fontSize: 12, padding: 16, usePointStyle: true }
        },
        animation: { animateRotate: true, duration: 1200, easing: 'easeOutQuart' },
        tooltips: {
          backgroundColor: '#1e293b', bodyFontColor: '#cbd5e1',
          cornerRadius: 8, xPadding: 12, yPadding: 10,
        }
      }
    });
  }, []);
  return (
    <div className="nova-chart-card">
      <div className="chart-header">
        <h3><i className="fas fa-chart-pie"></i> Active vs Inactive</h3>
      </div>
      <div className="chart-body" style={{ display: 'flex', justifyContent: 'center' }}>
        <canvas ref={canvasRef} style={{ minHeight: '260px', height: '260px', maxHeight: '260px', maxWidth: '100%' }}></canvas>
      </div>
    </div>
  );
}

/* ── Quick Actions ── */
function QuickActions() {
  return (
    <div className="nova-quick-actions">
      <a href={D.urls.userAdd} className="nova-quick-action">
        <i className="fas fa-user-plus" style={{ color: '#0ea5e9' }}></i> Add Customer
      </a>
      <a href={D.urls.planAdd} className="nova-quick-action">
        <i className="fas fa-plus-circle" style={{ color: '#8b5cf6' }}></i> Add Plan
      </a>
      <a href={D.urls.userList} className="nova-quick-action">
        <i className="fas fa-list" style={{ color: '#f59e0b' }}></i> All Customers
      </a>
      <a href={D.urls.planList} className="nova-quick-action">
        <i className="fas fa-tags" style={{ color: '#22c55e' }}></i> All Plans
      </a>
    </div>
  );
}

/* ── Plans Table ── */
function PlansTable() {
  return (
    <div className="nova-table-card">
      <div className="table-header">
        <h3><i className="fas fa-tags"></i> Subscription Plans</h3>
        <div className="table-actions">
          <a href={D.urls.planAdd} className="btn btn-sm btn-primary">
            <i className="fas fa-plus mr-1"></i> Add Plan
          </a>
        </div>
      </div>
      <div className="table-body">
        <table className="nova-table">
          <thead>
            <tr>
              <th>Plan Name</th>
              <th>Price</th>
              <th>Duration</th>
              <th>Subscribers</th>
              <th>Status</th>
              <th style={{ textAlign: 'right' }}>Actions</th>
            </tr>
          </thead>
          <tbody>
            {D.recentPlans.length === 0 ? (
              <tr>
                <td colSpan="6" style={{ textAlign: 'center', color: '#94a3b8', padding: '24px' }}>
                  No plans yet. <a href={D.urls.planAdd}>Add first plan.</a>
                </td>
              </tr>
            ) : D.recentPlans.map((plan, i) => (
              <tr key={plan.id}>
                <td><strong>{plan.name}</strong></td>
                <td>${plan.price}</td>
                <td>{plan.duration}</td>
                <td><span className="nova-pill nova-pill-info">{plan.subscribers}</span></td>
                <td>
                  {plan.isActive
                    ? <span className="nova-pill nova-pill-success"><i className="fas fa-check-circle" style={{fontSize:'0.65rem'}}></i> Active</span>
                    : <span className="nova-pill nova-pill-gray">Inactive</span>}
                </td>
                <td style={{ textAlign: 'right' }}>
                  <a href={plan.editUrl} className="btn btn-xs btn-warning text-white">
                    <i className="fas fa-edit"></i> Edit
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="table-footer">
        <a href={D.urls.planList} className="btn btn-sm btn-default">View All Plans</a>
      </div>
    </div>
  );
}

/* ── Customers Table ── */
function CustomersTable() {
  return (
    <div className="nova-table-card">
      <div className="table-header">
        <h3><i className="fas fa-users"></i> Recently Registered Customers</h3>
        <div className="table-actions">
          <a href={D.urls.userAdd} className="btn btn-sm btn-primary">
            <i className="fas fa-plus mr-1"></i> Add Customer
          </a>
        </div>
      </div>
      <div className="table-body">
        <table className="nova-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Joined</th>
              <th>Status</th>
              <th style={{ textAlign: 'right' }}>Actions</th>
            </tr>
          </thead>
          <tbody>
            {D.recentUsers.length === 0 ? (
              <tr>
                <td colSpan="6" style={{ textAlign: 'center', color: '#94a3b8', padding: '24px' }}>
                  No customers registered yet.
                </td>
              </tr>
            ) : D.recentUsers.map((u, i) => (
              <tr key={u.id}>
                <td>{i + 1}</td>
                <td>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <div style={{
                      width: '32px', height: '32px', borderRadius: '50%',
                      background: 'linear-gradient(135deg, #4f8ef7, #6366f1)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      color: '#fff', fontSize: '0.72rem', fontWeight: 700, flexShrink: 0
                    }}>
                      {u.name.charAt(0).toUpperCase()}
                    </div>
                    <span style={{ fontWeight: 600 }}>{u.name}</span>
                  </div>
                </td>
                <td>{u.email}</td>
                <td style={{ whiteSpace: 'nowrap' }}>{u.dateJoined}</td>
                <td>
                  {u.isActive
                    ? <span className="nova-pill nova-pill-success"><i className="fas fa-check-circle" style={{fontSize:'0.65rem'}}></i> Active</span>
                    : <span className="nova-pill nova-pill-danger"><i className="fas fa-times-circle" style={{fontSize:'0.65rem'}}></i> Inactive</span>}
                </td>
                <td style={{ textAlign: 'right', whiteSpace: 'nowrap' }}>
                  <a href={u.detailUrl} className="btn btn-xs btn-info text-white mr-1">
                    <i className="fas fa-eye"></i> View
                  </a>
                  <a href={u.editUrl} className="btn btn-xs btn-warning text-white">
                    <i className="fas fa-edit"></i> Edit
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="table-footer">
        <a href={D.urls.userList} className="btn btn-sm btn-default">View All Customers</a>
      </div>
    </div>
  );
}

/* ── Main Dashboard App ── */
function DashboardApp() {
  const now = new Date();
  const hour = now.getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

  return (
    <>
      {/* Content Header */}
      <div className="content-header">
        <div className="container-fluid">
          <div className="row align-items-center">
            <div className="col-sm-6">
              <h1 className="m-0" style={{ fontWeight: 800, color: '#0f172a', letterSpacing: '-0.5px' }}>
                <i className="fas fa-tachometer-alt mr-2" style={{ color: '#4f8ef7', fontSize: '1.1rem' }}></i>Dashboard
              </h1>
            </div>
            <div className="col-sm-6">
              <ol className="breadcrumb float-sm-right" style={{ background: 'transparent', padding: 0, margin: 0 }}>
                <li className="breadcrumb-item"><a href="#" style={{ color: '#4f8ef7' }}>Home</a></li>
                <li className="breadcrumb-item active" style={{ color: '#94a3b8' }}>Dashboard</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <section className="content">
        <div className="container-fluid">
          {/* Greeting */}
          <div className="nova-greeting">
            <h2>{greeting}, Administrator <span style={{ fontSize: '1.4rem' }}>&#128075;</span></h2>
            <p>{dateStr} &mdash; Here's what's happening with your platform today.</p>
          </div>

          {/* Quick Actions */}
          <QuickActions />

          {/* Stat Cards — Customer Row */}
          <div className="nova-stat-grid" style={{ gridTemplateColumns: 'repeat(4, 1fr)' }}>
            <StatCard icon="fa-users" value={D.usersCount} label="Total Customers"
              gradient="linear-gradient(135deg, #0ea5e9, #38bdf8)" bgIcon="fa-users"
              link={D.urls.userList} delay={0.05} />
            <StatCard icon="fa-user-check" value={D.activeUsersCount} label="Active Customers"
              gradient="linear-gradient(135deg, #22c55e, #4ade80)" bgIcon="fa-user-check"
              link={D.urls.userList} delay={0.1} />
            <StatCard icon="fa-user-plus" value={D.newUsersCount} label="New (Last 30 Days)"
              gradient="linear-gradient(135deg, #f59e0b, #fbbf24)" bgIcon="fa-user-plus"
              link={D.urls.userAdd} delay={0.15} />
            <StatCard icon="fa-user-slash" value={D.inactiveUsersCount} label="Inactive Customers"
              gradient="linear-gradient(135deg, #ef4444, #f87171)" bgIcon="fa-user-slash"
              link={D.urls.userList} delay={0.2} />
          </div>

          {/* Stat Cards — Subscription Row */}
          <div className="nova-stat-grid" style={{ gridTemplateColumns: 'repeat(3, 1fr)' }}>
            <StatCard icon="fa-tags" value={D.plansCount} label="Total Plans"
              gradient="linear-gradient(135deg, #8b5cf6, #a78bfa)" bgIcon="fa-tags"
              link={D.urls.planList} delay={0.08} />
            <StatCard icon="fa-check-circle" value={D.activePlansCount} label="Active Plans"
              gradient="linear-gradient(135deg, #0891b2, #22d3ee)" bgIcon="fa-check-circle"
              link={D.urls.planList} delay={0.14} />
            <StatCard icon="fa-star" value={D.activeSubsCount} label="Active Subscriptions"
              gradient="linear-gradient(135deg, #db2777, #f472b6)" bgIcon="fa-star"
              link={D.urls.planList} delay={0.2} />
          </div>

          {/* Charts */}
          <div className="nova-chart-grid">
            <BarChartCard />
            <DoughnutChartCard />
          </div>

          {/* Tables */}
          <PlansTable />
          <CustomersTable />
        </div>
      </section>
    </>
  );
}

/* ── Mount ── */
const root = ReactDOM.createRoot(document.getElementById('nova-dashboard-root'));
root.render(<DashboardApp />);
{% endverbatim %}
</script>
{% endblock %}
